package rvcore.isa

import chisel3._
import chisel3.util._
import utils._

object costom extends InstructionSet {
  protected object TrapDecoder extends Decoder {
    def apply(pc: UInt, instr: UInt): DecodeInfo =
      new DefaultDecodeInfo(pc, instr)
  }

  val instrSet: Array[(BitPat, Decoder)] = Array(
    // Trap
    (BitPat("b?????????????????????????_1101011"), TrapDecoder)
  )
}

object rv64i_opimm extends InstructionSet {
  protected object OpImmArithDecoder extends Decoder {
    def apply(pc: UInt, instr: UInt): DecodeInfo =
      new DefaultDecodeInfo(pc, instr) {
        bits.use_imm := true.B
        bits.imm := I_imm
        bits.alufn := ZeroExt(funct3, 4)
        bits.wb_rd := rd
      }
  }
  protected object OpImmFunctDecoder extends Decoder {
    def apply(pc: UInt, instr: UInt): DecodeInfo =
      new DefaultDecodeInfo(pc, instr) {
        bits.use_imm := true.B
        bits.imm := I_imm
        bits.alufn := Cat(instr(30), funct3)
        bits.wb_rd := rd
      }
  }

  val instrSet: Array[(BitPat, Decoder)] = Array(
    // ADDI
    (BitPat("b????????????_?????_000_?????_0010011"), OpImmArithDecoder),
    // SLLI
    (BitPat("b000000??????_?????_001_?????_0010011"), OpImmFunctDecoder),
    // SLTI
    (BitPat("b????????????_?????_010_?????_0010011"), OpImmArithDecoder),
    // SLTIU
    (BitPat("b????????????_?????_011_?????_0010011"), OpImmArithDecoder),
    // XORI
    (BitPat("b????????????_?????_100_?????_0010011"), OpImmArithDecoder),
    // SRLI
    (BitPat("b000000??????_?????_101_?????_0010011"), OpImmFunctDecoder),
    // SRAI
    (BitPat("b010000??????_?????_101_?????_0010011"), OpImmFunctDecoder),
    // ORI
    (BitPat("b????????????_?????_110_?????_0010011"), OpImmArithDecoder),
    // ANDI
    (BitPat("b????????????_?????_111_?????_0010011"), OpImmArithDecoder)
  )
}

object rv64i_op extends InstructionSet {
  protected object OpFunctDecoder extends Decoder {
    def apply(pc: UInt, instr: UInt): DecodeInfo =
      new DefaultDecodeInfo(pc, instr) {
        bits.alufn := Cat(instr(30), funct3)
        bits.wb_rd := rd
      }
  }

  val instrSet: Array[(BitPat, Decoder)] = Array(
    // ADD
    (BitPat("b0000000_?????_?????_000_?????_0110011"), OpFunctDecoder),
    // SUB
    (BitPat("b0100000_?????_?????_000_?????_0110011"), OpFunctDecoder),
    // SLL
    (BitPat("b0000000_?????_?????_001_?????_0110011"), OpFunctDecoder),
    // SLT
    (BitPat("b0000000_?????_?????_010_?????_0110011"), OpFunctDecoder),
    // SLTI
    (BitPat("b0000000_?????_?????_011_?????_0110011"), OpFunctDecoder),
    // XOR
    (BitPat("b0000000_?????_?????_100_?????_0110011"), OpFunctDecoder),
    // SRL
    (BitPat("b0000000_?????_?????_101_?????_0110011"), OpFunctDecoder),
    // SRA
    (BitPat("b0100000_?????_?????_101_?????_0110011"), OpFunctDecoder),
    // OR
    (BitPat("b0000000_?????_?????_110_?????_0110011"), OpFunctDecoder),
    // AND
    (BitPat("b0000000_?????_?????_111_?????_0110011"), OpFunctDecoder)
  )
}

object rv64i extends InstructionSet {
  val instrSet = rv64i_opimm.instrSet ++ rv64i_op.instrSet ++ custom.instrSet
}
